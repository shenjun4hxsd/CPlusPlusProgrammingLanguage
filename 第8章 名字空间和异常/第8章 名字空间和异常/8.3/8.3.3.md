##åœ¨è®¡ç®—å™¨ä¸­çš„å¼‚å¸¸

&emsp;&emsp;æœ‰äº†åŸºæœ¬çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥é‡åš6.1èŠ‚è®¡ç®—å™¨çš„ä¾‹å­ï¼Œå°†è¿è¡Œä¸­æ‰€å‘ç°çš„é”™è¯¯çš„å¤„ç†ä»è®¡ç®—å™¨çš„åŸºæœ¬é€»è¾‘ä¸­åˆ†ç¦»å‡ºæ¥ã€‚è¿™å°†å¯¼è‡´ä¸€ç§ç¨‹åºç»„ç»‡ç»“æ„ï¼Œå®ƒæ›´çœŸå®åœ°åæ˜ äº†é‚£äº›ç”±äº’ç›¸åˆ†ç¦»çš„è”ç³»æ¾æ•£çš„éƒ¨åˆ†æ„é€ å‡ºçš„ç¨‹åºçš„æƒ…å†µã€‚

&emsp;&emsp;é¦–å…ˆï¼Œå¯ä»¥åˆ é™¤error()ã€‚ä¸æ­¤å¯¹åº”ï¼Œåˆ†æå™¨å‡½æ•°åªçŸ¥é“å‘å‡ºé”™è¯¯ä¿¡å·æ‰€ä½¿ç”¨çš„ç±»å‹ï¼š

```javascript
    namespace Error {
        struct Zero_divide { };
        
        struct Syntax_error {
            const char* p;
            Syntax_error(const char* q) { p = q; }
        };
    }
```

åˆ†æå™¨æ£€æŸ¥ä¸‰ç§è¯­æ³•é”™è¯¯

```javascript
    Lexer::Token_value Lexer::get_token()
    {
        using namespace std;            // ä½¿ç”¨è¾“å…¥ï¼Œisalpha()ç­‰ï¼ˆ6.1.7èŠ‚ï¼‰
            // ...
            default:                    // NAME, NAME =, æˆ–è€…é”™è¯¯
                if(isalpha(ch)) {
                    string_value = ch;
                    while(input->get(ch) && isalnum(ch)) string_value.push_back(ch);
                    input->putback(ch);
                    return curr_tok = NAME;
                }
                throw Error::Syntax_error("bad token");
    }
    
    double Parser::prim(bool get)        // å¤„ç†åˆç­‰é¡¹
    {
        // ...
        case Lexer::LP:
        {
            double e = expr(true);
            if(curr_tok != Lexer::RP) throw Error::Syntax_error("')' expected");
            get_token();        // åƒæ‰ ')'
            return e;
        }
        case Lexer::END:
            return 1;
        default:
            throw Error::Syntax_error("primary expected");
    }
```

åœ¨æ£€æŸ¥ä¸€åˆ°ä¸€ä¸ªè¯­æ³•é”™è¯¯æ—¶ï¼Œä»£ç å°±é€šè¿‡throwå°†æ§åˆ¶ä¼ é€’åˆ°åœ¨æŸä¸ªï¼ˆç›´æ¥æˆ–é—´æ¥çš„ï¼‰è°ƒç”¨è€…é‡Œå®šä¹‰çš„å¼‚å¸¸å¤„ç†å™¨å»ã€‚throwè¿ç®—ç¬¦åŒæ—¶ç»™å¤„ç†å™¨é€å»ä¸€ä¸ªå€¼ã€‚ä¾‹å¦‚ï¼Œ

    throw Syntax_error("primary expected");

å°†å‘å¤„ç†å™¨ä¼ é€’ä¸€ä¸ªSyntax_errorå¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«ç€ä¸€ä¸ªæŒ‡å‘å­—ç¬¦ä¸²â€œprimary expectedâ€çš„æŒ‡é’ˆã€‚è¿™æ­£æ˜¯é‚£ä¸ªå¤„ç†å™¨æ‰€æœŸæœ›çš„ã€‚

&emsp;&emsp;æŠ¥å‘Šé™¤é›¶é”™è¯¯ä¸éœ€è¦ä¼ é€’ä»»ä½•æ•°æ®ï¼š

```javascript
    double Parser::term(bool get)        // ä¹˜å’Œé™¤
    {
        // ...
        case Lexer::DIV:
            if(double d = prim(true)) {
                left /= d;
                break;
            }
            throw Error::Zero_divide();
        // ...
    }
```

ç°åœ¨å®šä¹‰é©±åŠ¨ç¨‹åºï¼Œä½¿ä¹‹èƒ½å¤„ç†Zero_divideå’ŒSyntax_errorå¼‚å¸¸ã€‚æ¯”å¦‚å†™ï¼š

```javascript
    int main(int argc, char* argv[])
    {
        // ...
        while(*input) {
            try {
                Lexer::get_token();
                if(Lexer::curr_tok == Lexer::END) break;
                if(Lexer::curr_tok == Lexer::PRINT) continue;
                cout << Parser::expr(false) << '\n';
            }
            catch(Error::Zero_divide) {
                cerr << "attempt to divide by zero\n";
                if(Lexer::curr_tok != Lexer::PRINT) skip();
            }
            catch(Error::Syntax_error e)
            {
                cerr << "syntax error:" << e.p << '\n';
                if(Lexer::curr_tok != Lexer::PRINT) skip();
            }
        }
        if(input != &cin) delete input;
        return no_of_errors;
    }
```

é™¤éæ˜¯åœ¨è¡¨è¾¾å¼çš„æœ€åï¼Œç”±è¡¨ç¤ºç»“æŸçš„PRINTå•è¯ï¼ˆå³ï¼Œåˆ†å·æˆ–è€…æ¢è¡Œç¬¦ï¼‰å¼•èµ·çš„é”™è¯¯ï¼Œå¦åˆ™main()å°†è°ƒç”¨æ¢å¤å‡½æ•°skip()ã€‚å‡½æ•°skip()å°è¯•ç€å°†åˆ†æå™¨å¸¦å…¥ä¸€ä¸ªå®šä¹‰è‰¯å¥½çš„çŠ¶æ€ï¼Œå®ƒé‡‡ç”¨çš„æ–¹å¼å°±æ˜¯ä¸¢æ‰ä¸€ç³»åˆ—å­—ç¬¦ï¼Œç›´åˆ°é‡åˆ°ä¸€ä¸ªæ¢è¡Œç¬¦æˆ–è€…åˆ†å·ä¸ºæ­¢ã€‚å‡½æ•°skip()ã€no_of_errorså’Œinpntæ˜¯åå­—ç©ºé—´Driverçš„å½“ç„¶å€™é€‰æˆå‘˜ï¼š

```javascript
    namespace Driver {
        int no_of_errors;
        std::istream* input;
        void skip();
    }
    
    void Driver::skip()
    {
        no_of_errors++;
        while(*input) {        // ä¸¢æ‰ä¸€äº›å­—ç¬¦ï¼Œç›´è‡³é‡åˆ°æ¢è¡Œç¬¦æˆ–è€…åˆ†å·
            char ch;
            input->get(ch);
            switch(ch) {
            case '\n':
            case ';':
                return;
            }
        }
    }
```

skip()çš„ä»£ç çš„æŠ½è±¡å±‚æ¬¡æ¯”åˆ†æå™¨ä»£ç æ›´ä½ï¼Œè¿™æ ·åšæ˜¯æœ‰æ„çš„ï¼Œæ˜¯ä¸ºäº†é¿å…å®ƒåœ¨å¤„ç†ç”±åˆ†æå™¨æŠ¥å‘Šçš„å¼‚å¸¸æœŸé—´è¢«æ¥è‡ªåˆ†æå™¨çš„å¼‚å¸¸å¥—ä½ã€‚

&emsp;&emsp;æˆ‘ä¿ç•™äº†ç»Ÿè®¡å‡ºé”™æ¬¡æ•°å¹¶å°†è¿™ä¸ªæ•°é€šè¿‡ç¨‹åºè¿”å›å€¼æŠ¥å‘Šçš„æƒ³æ³•ã€‚çŸ¥é“ä¸€ä¸ªç¨‹åºæ˜¯å¦é‡åˆ°é”™è¯¯ï¼Œå®ƒæ˜¯å¦èƒ½å¤Ÿä»é”™è¯¯ä¸­æ¢å¤ç­‰ï¼Œè¿™äº›éƒ½æ˜¯éå¸¸æœ‰ä»·å€¼ã€‚

&emsp;&emsp;æˆ‘æ²¡æœ‰å°†mainæ”¾è¿›Driveråå­—ç©ºé—´ã€‚å…¨å±€çš„mainæ˜¯æ•´ä¸ªç¨‹åºçš„åˆå¯å‡½æ•°ï¼ˆ3.2èŠ‚ï¼‰ï¼Œå‡ºç°åœ¨æŸä¸ªåå­—ç©ºé—´é‡Œçš„main()å°±æ²¡æœ‰ç‰¹æ®Šæ„ä¹‰äº†ã€‚åœ¨å®é™…è§„æ¨¡çš„ç¨‹åºä¸­ï¼Œåº”è¯¥å°†main()ä¸­çš„å¤§éƒ¨åˆ†ä»£ç ç§»åˆ°Driveré‡Œçš„å¦ä¸€ä¸ªç‹¬ç«‹å‡½æ•°é‡Œã€‚

ğŸ”š






