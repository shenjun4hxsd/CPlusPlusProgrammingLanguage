##å­˜å‚¨è€—å°½

&emsp;&emsp;è‡ªç”±å­˜å‚¨è¿ç®—ç¬¦newã€deleteã€new[]å’Œdelete[]é€šè¿‡ä¸€äº›åœ¨å¤´æ–‡ä»¶`<new>`é‡Œæè¿°çš„å‡½æ•°å®ç°ï¼ˆ19.4.5èŠ‚ï¼‰ï¼š

```javascript
    void* operator new(size_t);        // ä¸ºå•ä¸ªå¯¹è±¡åˆ†é…ç©ºé—´
    void operator delete(void*);
    void* operator new[](size_t);      // ä¸ºæ•°ç»„åˆ†é…ç©ºé—´
    void operator delete[](void*);
```

å½“è¿ç®—ç¬¦newéœ€è¦ä¸ºæŸä¸ªå¯¹è±¡åˆ†é…ç©ºé—´æ—¶ï¼Œå®ƒå°†è°ƒç”¨operator new()å»åˆ†é…é€‚å½“æ•°é‡çš„å­—èŠ‚ã€‚ä¸æ­¤ç±»ä¼¼ï¼Œå½“è¿ç®—ç¬¦newéœ€è¦ä¸ºä¸€ä¸ªæ•°ç»„åˆ†é…ç©ºé—´æ—¶ï¼Œå°±å»è°ƒç”¨operator new[]()ã€‚

&emsp;&emsp;operator new()å’Œoperator new[]()çš„æ ‡å‡†å®ç°å¹¶ä¸å¯¹è¿”å›çš„å­˜å‚¨åšåˆå§‹åŒ–ã€‚

&emsp;&emsp;å½“newæ— æ³•æ‰¾åˆ°éœ€è¦åˆ†é…çš„ç©ºé—´æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µå‘¢ï¼ŸæŒ‰ç…§é»˜è®¤æ–¹å¼ï¼Œè¿™ä¸ªåˆ†é…å‡½æ•°å°†æŠ›å‡ºä¸€ä¸ªbad_allocå¼‚å¸¸ï¼ˆå¦ä¸€ç§æƒ…å†µè§19.4.5èŠ‚ï¼‰ã€‚ä¾‹å¦‚ï¼Œ

```javascript
    void f()
    {
        try {
            for(;;) new char[10000];
        }
        catch(bad_alloc) {
            cerr << "Memory exhausted!\n";
        }
    }
```

æ— è®ºæˆ‘ä»¬èƒ½ç”¨çš„ç©ºé—´æœ‰å¤šå°‘ï¼Œè¿™ä¸€ç¨‹åºæœ€ç»ˆéƒ½ä¼šæ¿€æ´»bad_allocå¤„ç†å™¨ã€‚

&emsp;&emsp;æˆ‘ä»¬å¯ä»¥è§„å®šåœ¨å­˜å‚¨è€—å°½æ—¶newåº”è¯¥å»åšä»€ä¹ˆã€‚å½“newå¤±è´¥æ—¶ï¼Œå®ƒå°†å…ˆå»è°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œè¯¥å‡½æ•°æ˜¯é€šè¿‡è°ƒç”¨åœ¨ `<new>` é‡Œå£°æ˜çš„set_new_handler()è®¾å®šçš„ã€‚ä¾‹å¦‚ï¼Œ

```javascript
    void out_of_store()
    {
        cerr << "operator new failed: out of store\n";
        throw bad_alloc();
    }
    
    int main()
    {
        set_new_handler(out_of_store);    // å°†out_of_store()ä½œä¸ºæ–°çš„å¤„ç†å‡½æ•°
        for(;;) new char[10000];
        cout << "done\n";
    }
```

è¿™ä¸ªç¨‹åºä¸ä¼šåˆ°è¾¾å†™å‡ºdoneçš„åœ°æ–¹ã€‚å®ƒå°†å†™å‡º

    operator new failed: out of store
    
åƒçœ‹14.4.5èŠ‚å…³äºoperator new()çš„å¯èƒ½å®ç°æƒ…å†µï¼Œå®ƒæ£€æŸ¥æ˜¯å¦å­˜åœ¨ç€èƒ½è°ƒç”¨çš„å¤„ç†å‡½æ•°ï¼Œå¦‚æœæ²¡æœ‰å°±æŠ›å‡ºbad_allocã€‚new_handeræœ‰å¯èƒ½åšå‡ºæŸäº›æ¯”ç®€å•åœ°ç»ˆæ­¢ç¨‹åºæ›´èªæ˜çš„äº‹æƒ…ã€‚å¦‚æœä½ çŸ¥é“newå’Œdeleteæ˜¯å¦‚ä½•å·¥ä½œçš„---ä¾‹å¦‚å› ä¸ºä½ æä¾›äº†è‡ªå·±çš„operator new()å’Œoperator delete()ï¼Œè¿™ä¸ªå¤„ç†å‡½æ•°å¯èƒ½æ˜¯ä¼å›¾å»ä¸ºnewæ‰¾åˆ°å¦ä¸€äº›å­˜å‚¨å¹¶è¿”å›ä¹‹ã€‚å¦ä¸€ç§æ–¹å¼æ˜¯ï¼ŒæŸä¸ªç”¨æˆ·å¯èƒ½æä¾›ä¸€ä¸ªåºŸæ–™æ”¶é›†å™¨ï¼Œä½¿å¾—deleteçš„ä½¿ç”¨å˜æˆé€‰æ‹©æ€§çš„ã€‚å½“ç„¶ï¼Œåšè¿™äº›äº‹æƒ…éƒ½ä¸æ˜¯ä¸€ä¸ªåˆå­¦è€…çš„å·¥ä½œã€‚å¯¹äºæ‰€æœ‰éœ€è¦è‡ªåŠ¨åºŸæ–™æ”¶é›†å™¨çš„äººè€Œè¨€ï¼Œåº”è¯¥åšçš„æ­£ç¡®äº‹æƒ…æ˜¯å»è·å¾—ä¸€ä¸ªå·²ç»å†™å¥½å¹¶ç»è¿‡ä»”ç»†æµ‹è¯•çš„ç¨‹åºï¼ˆC.9.1èŠ‚ï¼‰ã€‚

&emsp;&emsp;é€šè¿‡æä¾›new_handlerï¼Œæˆ‘ä»¬å°±å¤„ç†äº†åœ¨ç¨‹åºä¸­æ‰€æœ‰newçš„å¸¸è§„ä½¿ç”¨ä¸­å¯¹å­˜å‚¨è€—å°½æƒ…å†µçš„æ£€æŸ¥ã€‚ä¹Ÿå­˜åœ¨å¦å¤–ä¸¤ç§æ§åˆ¶å­˜å‚¨åˆ†é…çš„æ›¿ä»£æ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥ä¸ºnewçš„éæ ‡å‡†ä½¿ç”¨æä¾›éæ ‡å‡†çš„åˆ†é…å‡½æ•°å’Œé‡Šæ”¾å‡½æ•°ï¼ˆ15.6èŠ‚ï¼‰ï¼Œæˆ–è€…æ˜¯ä¾é ç”¨æˆ·æä¾›æœ‰å…³å­˜å‚¨åˆ†é…çš„é™„åŠ ä¿¡æ¯ï¼ˆ10.4.11èŠ‚ã€19.4.5èŠ‚ï¼‰ã€‚


ğŸ”š



